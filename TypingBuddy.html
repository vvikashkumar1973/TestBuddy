<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Typing Test - TestBuddy.in</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .cta-button {
            transition: all 0.3s ease;
        }
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        #source-text {
            position: relative; /* Fix for accurate scrolling calculation */
            height: 144px; /* Roughly 3 lines of text */
            overflow-y: auto;
            user-select: none;
            font-size: 1.5rem; /* 24px */
            line-height: 2.8rem; /* 40px */
            letter-spacing: 1px;
            scroll-behavior: smooth;
        }
        #source-text .char { color: #6b7280; }
        #source-text .char.correct { color: #16a34a; }
        #source-text .char.incorrect { color: #dc2626; background-color: #fee2e2; border-radius: 2px; }
        #source-text .char.current { background-color: #dbeafe; border-radius: 2px; }
        .keyboard { display: flex; flex-direction: column; gap: 8px; }
        .keyboard-row { display: flex; justify-content: center; gap: 6px; }
        .key { display: flex; justify-content: center; align-items: center; border: 1px solid #d1d5db; border-radius: 6px; background-color: #fff; font-size: 1rem; min-width: 40px; height: 40px; padding: 0 5px; transition: 0.3s; }
        .key.wide { flex-grow: 1; }
        .key.error-low { background-color: #fef08a; border-color: #facc15; }
        .key.error-medium { background-color: #fb923c; border-color: #f97316; color: white; }
        .key.error-high { background-color: #ef4444; border-color: #dc2626; color: white; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="TestBuddy.html" class="text-2xl font-bold text-blue-600">TestBuddy.in</a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="TestBuddy.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Home</a>
                <a href="Tests.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Tests</a>
                <a href="TypingBuddy.html" class="nav-link text-blue-600 font-semibold">Typing Test</a>
                <a href="Analytics.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Analytics</a>
                <a href="About.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">About</a>
                <a href="Contact.html" class="nav-link text-gray-600 hover:text-blue-600 font-medium">Contact</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="Login.html" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold cta-button">Login / Sign Up</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <!-- Login Prompt (Initially hidden) -->
        <div id="login-prompt" class="hidden text-center max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold mb-4">Login Required</h2>
            <p class="text-gray-600 mb-6">Please log in to access the typing test and save your progress.</p>
            <a href="Login.html" id="login-redirect-btn" class="bg-blue-600 text-white font-bold px-8 py-3 rounded-lg cta-button hover:bg-blue-700">Go to Login</a>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-gray-900">Advanced Typing Test</h1>
                    <p class="text-lg text-gray-600 mt-2">Focus on continuous flow and analyze your weak points.</p>
                </div>

                <!-- Setup & Controls -->
                <div id="setup-container" class="flex flex-col md:flex-row gap-4 justify-center items-center mb-8 p-4 bg-white rounded-lg shadow">
                    <div class="flex items-center gap-2">
                        <label for="time-select" class="font-medium">Duration:</label>
                        <select id="time-select" class="border-gray-300 rounded-md shadow-sm">
                            <option value="60">1 Minute</option>
                            <option value="120">2 Minutes</option>
                            <option value="300" selected>5 Minutes</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <label for="difficulty-select" class="font-medium">Difficulty:</label>
                        <select id="difficulty-select" class="border-gray-300 rounded-md shadow-sm">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <button id="start-btn" class="bg-indigo-500 text-white font-bold px-6 py-2 rounded-lg cta-button hover:bg-indigo-600">
                        Start Test
                    </button>
                </div>

                <!-- Test Results / Dashboard -->
                <div id="results-dashboard" class="mb-8">
                     <h2 class="text-2xl font-semibold text-center mb-4">Your Progress</h2>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div class="bg-white p-4 rounded-lg shadow">
                             <canvas id="progress-chart"></canvas>
                         </div>
                         <div class="bg-white p-4 rounded-lg shadow">
                            <h3 class="font-semibold mb-2">Recent Attempts</h3>
                            <div class="max-h-64 overflow-y-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Date</th>
                                            <th scope="col" class="px-6 py-3">WPM</th>
                                            <th scope="col" class="px-6 py-3">Accuracy</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table">
                                        <!-- History rows will be injected here -->
                                    </tbody>
                                </table>
                            </div>
                         </div>
                     </div>
                </div>

                <!-- Typing Interface (Initially hidden) -->
                <div id="typing-interface" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-md mb-8">
                        <div class="text-center">
                            <p class="text-sm font-medium text-gray-500">Time Left</p>
                            <p id="timer" class="text-4xl font-bold text-blue-600">5:00</p>
                        </div>
                        <div class="flex items-center gap-4">
                             <button id="pause-btn" class="bg-yellow-500 text-white font-bold px-6 py-2 rounded-lg cta-button hover:bg-yellow-600">Pause</button>
                             <button id="stop-btn" class="bg-red-500 text-white font-bold px-6 py-2 rounded-lg cta-button hover:bg-red-600">Stop</button>
                             <button id="cancel-btn" class="bg-gray-500 text-white font-bold px-6 py-2 rounded-lg cta-button hover:bg-gray-600">Cancel</button>
                        </div>
                    </div>
                    <div id="source-text" class="p-4 border rounded-lg bg-gray-100 mb-4"></div>
                    <textarea id="user-input" class="w-full text-2xl p-4 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none" rows="5" disabled></textarea>
                </div>
            </div>
        </div>
    </main>

    <!-- Results Modal -->
    <div id="results-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full">
            <h2 class="text-3xl font-bold text-center mb-6">Test Completed!</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center mb-8">
                <div><p class="text-gray-500">Net WPM</p><p id="net-wpm" class="text-3xl font-bold"></p></div>
                <div><p class="text-gray-500">Accuracy</p><p id="final-accuracy" class="text-3xl font-bold"></p></div>
                <div><p class="text-gray-500">Errors</p><p id="total-errors" class="text-3xl font-bold"></p></div>
                <div><p class="text-gray-500">Gross WPM</p><p id="gross-wpm" class="text-3xl font-bold"></p></div>
            </div>
            <h3 class="text-xl font-semibold text-center mb-4">Keys to Practice</h3>
            <div id="keyboard-analysis" class="keyboard max-w-2xl mx-auto p-4 bg-gray-100 rounded-lg"></div>
            <div class="text-center mt-8">
                <button id="try-again-btn" class="bg-blue-600 text-white font-bold px-8 py-3 rounded-lg cta-button hover:bg-blue-700">Try Again</button>
            </div>
        </div>
    </div>
    
<script>
// Authentication Check
function checkAuth() {
    const isLoggedIn = localStorage.getItem('tb_logged_in') === 'true';
    const mainContent = document.getElementById('main-content');
    const loginPrompt = document.getElementById('login-prompt');
    
    if (!isLoggedIn) {
        mainContent.classList.add('hidden');
        loginPrompt.classList.remove('hidden');
        const loginRedirectBtn = document.getElementById('login-redirect-btn');
        const redirectPage = window.location.pathname.split('/').pop();
        loginRedirectBtn.href = `Login.html?redirect=${encodeURIComponent(redirectPage)}`;
    } else {
        mainContent.classList.remove('hidden');
        loginPrompt.classList.add('hidden');
        initializeApp();
    }
}


function initializeApp() {
    // DOM Elements
    const elements = {
        timeSelect: document.getElementById('time-select'),
        difficultySelect: document.getElementById('difficulty-select'),
        startBtn: document.getElementById('start-btn'),
        timer: document.getElementById('timer'),
        sourceText: document.getElementById('source-text'),
        userInput: document.getElementById('user-input'),
        resultsModal: document.getElementById('results-modal'),
        netWpm: document.getElementById('net-wpm'),
        finalAccuracy: document.getElementById('final-accuracy'),
        totalErrors: document.getElementById('total-errors'),
        grossWpm: document.getElementById('gross-wpm'),
        keyboardAnalysis: document.getElementById('keyboard-analysis'),
        tryAgainBtn: document.getElementById('try-again-btn'),
        typingInterface: document.getElementById('typing-interface'),
        resultsDashboard: document.getElementById('results-dashboard'),
        setupContainer: document.getElementById('setup-container'),
        historyTable: document.getElementById('history-table'),
        progressChart: document.getElementById('progress-chart'),
        pauseBtn: document.getElementById('pause-btn'),
        stopBtn: document.getElementById('stop-btn'),
        cancelBtn: document.getElementById('cancel-btn'),
    };

    let allPassages = [];
    let state = {};
    let chartInstance = null;
    const currentUserId = localStorage.getItem('tb_current_user_id');

    const keyboardLayout = [
        ['`', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '='],
        ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', '[', ']', '\\'],
        ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';', "'"],
        ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/'],
        ['space']
    ];

    async function fetchParagraphs() {
        try {
            const response = await fetch(`assets/data/typing-passages.json?v=${new Date().getTime()}`);
            allPassages = await response.json();
        } catch (error) {
            console.error("Failed to load passages:", error);
            allPassages = [{ level: 'easy', text: "The quick brown fox jumps over the lazy dog." }];
        }
    }
    
    async function getUserHistory() {
        try {
            const cachedHistory = localStorage.getItem('tb_typing_history_cache');
            if (cachedHistory) {
                const allHistory = JSON.parse(cachedHistory);
                return allHistory[currentUserId] || [];
            }
            // Fetch from file only if cache is empty
            const response = await fetch(`assets/data/userTypingresult.json?v=${new Date().getTime()}`);
            const allHistory = await response.json();
            localStorage.setItem('tb_typing_history_cache', JSON.stringify(allHistory));
            return allHistory[currentUserId] || [];
        } catch (e) {
            console.error("Failed to get user history:", e);
            return [];
        }
    }
    
    async function saveUserHistory(newEntry) {
        try {
            let allHistory = {};
            const cachedHistory = localStorage.getItem('tb_typing_history_cache');
            
            if (cachedHistory) {
                allHistory = JSON.parse(cachedHistory);
            } else {
                 try {
                    const response = await fetch(`assets/data/userTypingresult.json?v=${new Date().getTime()}`);
                    allHistory = await response.json();
                } catch(fetchErr) {
                    console.warn("Could not fetch initial history, starting fresh.");
                }
            }

            if (!allHistory[currentUserId]) {
                allHistory[currentUserId] = [];
            }
            allHistory[currentUserId].push(newEntry);

            localStorage.setItem('tb_typing_history_cache', JSON.stringify(allHistory));
        } catch (e) {
            console.error("Failed to save user history:", e);
        }
    }

    function resetState() {
        const selectedDifficulty = elements.difficultySelect.value;
        const filteredPassages = allPassages.filter(p => p.level === selectedDifficulty);
        
        let selectedPassage = { text: "No passages available for this difficulty." };
        if (filteredPassages.length > 0) {
            const randomIndex = Math.floor(Math.random() * filteredPassages.length);
            selectedPassage = filteredPassages[randomIndex];
            elements.startBtn.disabled = false;
        } else {
            elements.startBtn.disabled = true;
        }

        state = {
            timer: parseInt(elements.timeSelect.value),
            timeLeft: parseInt(elements.timeSelect.value),
            interval: null,
            testActive: false,
            isPaused: false,
            sourceText: selectedPassage.text,
            typedText: '',
            errors: 0,
            totalChars: 0,
            errorLog: {},
        };
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s < 10 ? '0' : ''}${s}`;
    }

    function updateTimerDisplay() {
        elements.timer.textContent = formatTime(state.timeLeft);
    }

    function setupTest() {
        resetState();
        updateTimerDisplay();
        elements.sourceText.innerHTML = '';
        state.sourceText.split('').forEach(char => {
            const charSpan = document.createElement('span');
            charSpan.className = 'char';
            charSpan.textContent = char;
            elements.sourceText.appendChild(charSpan);
        });
        if(elements.sourceText.children[0]) {
            elements.sourceText.children[0].classList.add('current');
        }
        elements.userInput.value = '';
    }

    function startTest() {
        if (elements.startBtn.disabled) return;
        setupTest();
        elements.resultsDashboard.classList.add('hidden');
        elements.setupContainer.classList.add('hidden');
        elements.typingInterface.classList.remove('hidden');
        elements.userInput.disabled = false;
        elements.userInput.focus();
        elements.pauseBtn.textContent = 'Pause';
    }

    function startTimer() {
        if(state.testActive || state.isPaused) return;
        state.testActive = true;
        state.interval = setInterval(() => {
            if (state.isPaused) return;
            state.timeLeft--;
            updateTimerDisplay();
            if (state.timeLeft <= 0) {
                endTest();
            }
        }, 1000);
    }
    
    function togglePause() {
        if (!state.testActive) return;
        state.isPaused = !state.isPaused;
        if (state.isPaused) {
            elements.userInput.disabled = true;
            elements.pauseBtn.textContent = 'Resume';
        } else {
            elements.userInput.disabled = false;
            elements.userInput.focus();
            elements.pauseBtn.textContent = 'Pause';
        }
    }

    async function endTest() {
        if (!state.testActive) return;
        clearInterval(state.interval);
        state.testActive = false;
        state.isPaused = false;
        elements.userInput.blur();
        elements.userInput.disabled = true;
        
        const minutes = (state.timer - state.timeLeft) / 60;
        const grossWpm = minutes > 0 ? Math.round((state.typedText.length / 5) / minutes) : 0;
        const netWpm = minutes > 0 ? Math.max(0, Math.round(grossWpm - (state.errors / minutes))) : 0;
        const accuracy = state.totalChars > 0 ? Math.round(((state.totalChars - state.errors) / state.totalChars) * 100) : 100;

        const result = {
            wpm: netWpm,
            accuracy: accuracy,
            grossWpm: grossWpm,
            errors: state.errors,
            timestamp: new Date().toISOString()
        };

        await saveUserHistory(result);
        showResults(result);
    }
    
    function cancelTest() {
        if (!state.testActive && !state.isPaused) return;
        clearInterval(state.interval);
        state.testActive = false;
        state.isPaused = false;
        returnToDashboard();
    }

    function showResults(result) {
        elements.netWpm.textContent = result.wpm;
        elements.grossWpm.textContent = result.grossWpm;
        elements.finalAccuracy.textContent = `${result.accuracy}%`;
        elements.totalErrors.textContent = result.errors;
        renderKeyboardAnalysis();
        elements.resultsModal.classList.remove('hidden');
    }
    
    function renderKeyboardAnalysis() {
        elements.keyboardAnalysis.innerHTML = '';
        const maxErrors = Math.max(1, ...Object.values(state.errorLog));

        keyboardLayout.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'keyboard-row';
            row.forEach(key => {
                const keyDiv = document.createElement('div');
                keyDiv.className = 'key';
                keyDiv.textContent = key === 'space' ? 'Space' : key;
                if (key === 'space') keyDiv.classList.add('wide');

                const errorCount = state.errorLog[key.toLowerCase()] || 0;
                if (errorCount > 0) {
                    const errorRatio = errorCount / maxErrors;
                    if (errorRatio > 0.66) keyDiv.classList.add('error-high');
                    else if (errorRatio > 0.33) keyDiv.classList.add('error-medium');
                    else keyDiv.classList.add('error-low');
                }
                rowDiv.appendChild(keyDiv);
            });
            elements.keyboardAnalysis.appendChild(rowDiv);
        });
    }

    async function returnToDashboard() {
        elements.resultsModal.classList.add('hidden');
        elements.typingInterface.classList.add('hidden');
        elements.resultsDashboard.classList.remove('hidden');
        elements.setupContainer.classList.remove('hidden');
        await renderDashboard();
    }

    function handleInput() {
        if (state.timeLeft <= 0 || state.isPaused) return;
        if (!state.testActive) {
            startTimer();
        }

        state.typedText = elements.userInput.value;
        const typedIndex = state.typedText.length - 1;
        const allCharSpans = elements.sourceText.children;
        
        state.errors = 0;
        state.totalChars = state.typedText.length;
        
        state.typedText.split('').forEach((char, index) => {
            const sourceChar = state.sourceText[index];
            const charSpan = allCharSpans[index];
            if(charSpan) {
                charSpan.classList.remove('correct', 'incorrect');
                if (char === sourceChar) {
                    charSpan.classList.add('correct');
                } else {
                    charSpan.classList.add('incorrect');
                    state.errors++;
                    const wrongKey = sourceChar.toLowerCase();
                    state.errorLog[wrongKey] = (state.errorLog[wrongKey] || 0) + 1;
                }
            }
        });

        Array.from(allCharSpans).forEach(span => span.classList.remove('current'));
        if (allCharSpans[typedIndex + 1]) {
            allCharSpans[typedIndex + 1].classList.add('current');
        }
        
        const currentSpan = allCharSpans[typedIndex];
        if (currentSpan) {
            const scrollOffset = currentSpan.offsetTop - elements.sourceText.clientHeight / 2 + currentSpan.offsetHeight / 2;
            elements.sourceText.scrollTop = scrollOffset;
        }
        
        if (typedIndex + 1 >= state.sourceText.length) {
            endTest();
        }
    }
    
    async function renderDashboard() {
        const history = await getUserHistory();
        elements.historyTable.innerHTML = history.length ? '' : '<tr><td colspan="3" class="text-center p-4">No attempts yet.</td></tr>';
        
        const recentHistory = [...history].reverse().slice(0, 10);
        recentHistory.forEach(item => {
            const dateObj = new Date(item.timestamp);
            const formattedDate = !isNaN(dateObj.getTime())
                ? dateObj.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })
                : 'Invalid Date';

            const row = `
                <tr class="bg-white border-b">
                    <td class="px-6 py-4">${formattedDate}</td>
                    <td class="px-6 py-4">${item.wpm}</td>
                    <td class="px-6 py-4">${item.accuracy}%</td>
                </tr>`;
            elements.historyTable.innerHTML += row;
        });

        if (chartInstance) {
            chartInstance.destroy();
        }

        if (history.length > 0) {
            const labels = history.map((item, i) => {
                const dateObj = new Date(item.timestamp);
                return !isNaN(dateObj.getTime())
                    ? dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })
                    : `Test ${i + 1}`;
            });
            const wpmData = history.map(item => item.wpm);
            const accuracyData = history.map(item => item.accuracy);

            chartInstance = new Chart(elements.progressChart, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'WPM', data: wpmData, borderColor: '#3b82f6', tension: 0.1, yAxisID: 'y' },
                        { label: 'Accuracy (%)', data: accuracyData, borderColor: '#16a34a', tension: 0.1, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'WPM' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Accuracy' }, grid: { drawOnChartArea: false }, min: 0, max: 100 }
                    }
                }
            });
        }
    }

    // Event Listeners
    elements.userInput.addEventListener('input', handleInput);
    elements.startBtn.addEventListener('click', startTest);
    elements.tryAgainBtn.addEventListener('click', returnToDashboard);
    elements.pauseBtn.addEventListener('click', togglePause);
    elements.stopBtn.addEventListener('click', () => {
        if(state.testActive) {
            endTest();
        }
    });
    elements.cancelBtn.addEventListener('click', cancelTest);
    
    // Initial Load for logged-in user
    (async function(){
        await fetchParagraphs();
        await renderDashboard();
    })();
}

// Run authentication check on page load
window.onload = checkAuth;

</script>

</body>
</html>

